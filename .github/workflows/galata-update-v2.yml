name: Update Playwright Snapshots

on:
  # act on comments on PR
  issue_comment:
    types: [created, edited]
  # act on review body (the "main" review comment)
  pull_request_review:
    types: [submitted, edited]
  # act on individual review comments
  pull_request_review_comment:
    types: [created, edited]

# Disable permissions for all of the available permissions.
permissions: {}

jobs:
  start-work:
    name: Start work
    if: >
      (github.event.issue.pull_request || github.event.pull_request) &&
      (
        contains(github.event.comment.body || github.event.review.body || '', 'would you be so kind as to update galata snapshots please') ||
        contains(github.event.comment.body || github.event.review.body || '', 'would you be so kind as to update snapshots please')
      )
    runs-on: ubuntu-slim
    environment: update-snapshots
    steps:
      - uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: React positively to the triggering comment
        shell: bash -l {0}
        run: |
          if [[ "${{ github.event_name }}" == "pull_request_review" ]]; then
            gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews/${{ github.event.review.id }}/reactions --raw-field 'content=+1'
          else
            gh api repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions --raw-field 'content=+1'
          fi
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

  get-snapshot-updates:
    name: Fetch test assets once ready
    runs-on: ubuntu-24.04
    needs: [start-work]
    timeout-minutes: 20
    permissions:
      actions: read
      contents: read
      pull-requests: read
    outputs:
      pr-base-ref: ${{ steps.get-pr-info.outputs.base-ref }}
      pr-head-ref: ${{ steps.get-pr-info.outputs.head-ref }}
      pr-head-repo: ${{ steps.get-pr-info.outputs.head-repo }}
      pr-head-owner: ${{ steps.get-pr-info.outputs.head-owner }}
      is-pr-from-fork: ${{ steps.get-pr-info.outputs.is-pr-from-fork }}
      assets-run-id: ${{ steps.download.outputs.assets-run-id }}
    steps:
      - name: Get PR information
        id: get-pr-info
        run: |
          PR_NUMBER=${{ github.event.issue.number || github.event.pull_request.number }}
          PR_DATA=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER)
          BASE_REF=$(echo "$PR_DATA" | jq -r '.base.ref')
          HEAD_REF=$(echo "$PR_DATA" | jq -r '.head.ref')
          HEAD_REPO=$(echo "$PR_DATA" | jq -r '.head.repo.full_name')
          HEAD_OWNER=$(echo "$PR_DATA" | jq -r '.head.repo.owner.login')
          IS_PR_FROM_FORK=$(echo "$PR_DATA" | jq -r --arg repo "${{ github.repository }}" '.head.repo.full_name != $repo')
          echo "base-ref=$BASE_REF" >> $GITHUB_OUTPUT
          echo "head-ref=$HEAD_REF" >> $GITHUB_OUTPUT
          echo "head-repo=$HEAD_REPO" >> $GITHUB_OUTPUT
          echo "head-owner=$HEAD_OWNER" >> $GITHUB_OUTPUT
          echo "is-pr-from-fork=$IS_PR_FROM_FORK" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for galata-test-assets-merged artifact
        id: download
        run: |
          PR_NUMBER=${{ github.event.issue.number || github.event.pull_request.number }}
          PR_HEAD_REF=${{ steps.get-pr-info.outputs.head-ref }}
          ARTIFACT_NAME="galata-test-assets-merged"
          MAX_WAIT=1800  # 30 minutes
          ELAPSED=0

          echo "Waiting for artifact: $ARTIFACT_NAME from PR #$PR_NUMBER (head ref: $PR_HEAD_REF)"

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            echo "Checking for artifact... (elapsed: ${ELAPSED}s)"

            # Get recent workflow runs and try the most relevant candidates first.
            RUNS=$(gh run list \
              --repo ${{ github.repository }} \
              --workflow galata.yml \
              --status completed \
              --json databaseId,event,headBranch,headSha,conclusion,createdAt \
              --limit 20)

            if [ -z "$RUNS" ] || [ "$RUNS" = "[]" ]; then
              echo "No completed galata.yml runs found yet"
            else
              echo "Recent galata.yml runs (up to 20):"
              echo "$RUNS" | jq -r '.[] | "  id=\(.databaseId) event=\(.event) branch=\(.headBranch) sha=\(.headSha) conclusion=\(.conclusion) created=\(.createdAt)"'

              RUN_IDS=$(echo "$RUNS" | jq -r --arg ref "$PR_HEAD_REF" '[.[] | select(.headBranch == $ref) | .databaseId] | .[]')
              if [ -z "$RUN_IDS" ]; then
                echo "No runs matched head ref '$PR_HEAD_REF'; trying all recent galata.yml runs"
                RUN_IDS=$(echo "$RUNS" | jq -r '.[].databaseId')
              fi

              for RUN_ID in $RUN_IDS; do
                echo "Trying artifact download from run $RUN_ID"
                rm -rf ./artifact
                if gh run download "$RUN_ID" \
                  --repo ${{ github.repository }} \
                  --name $ARTIFACT_NAME \
                  --dir ./artifact 2>/dev/null; then
                  echo "Artifact downloaded successfully from run $RUN_ID"
                  echo "assets-run-id=$RUN_ID" >> $GITHUB_OUTPUT
                  exit 0
                fi
              done
            fi

            # Wait before retrying
            sleep 15
            ELAPSED=$((ELAPSED + 15))
          done

          echo "::error::Timeout waiting for artifact after ${MAX_WAIT}s"
          exit 1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-branch:
    name: Replace snapshots
    needs: [get-snapshot-updates]
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    permissions:
      contents: write
    outputs:
      branch-name: ${{ steps.create-branch.outputs.branch-name }}
      has-changes: ${{ steps.check-changes.outputs.has-changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.issue.number || github.event.pull_request.number }}/head
          fetch-depth: 0

      - name: Download test results
        run: |
          gh run download ${{ needs.get-snapshot-updates.outputs.assets-run-id }} --repo ${{ github.repository }} --name galata-test-assets-merged --dir ./test-assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get unpack_snapshots.py from the main repo
        run: |
          git fetch origin refs/heads/${{ github.event.repository.default_branch }}:refs/remotes/origin/${{ github.event.repository.default_branch }}
          git show origin/${{ github.event.repository.default_branch }}:scripts/unpack_snapshots.py > unpack_snapshots.py
          chmod +x unpack_snapshots.py

      - name: List tests assets
        run: |
          echo "Test assets contents:"
          find ./test-assets -type f -name "*.json" -o -name "*.png"

      - name: Process JSON reports and unpack snapshots
        run: |
          python unpack_snapshots.py ./test-assets

      - name: Create snapshot-update branch
        id: create-branch
        run: |
          set -ex
          DATE=$(date +%Y%m%d)
          BRANCH_NAME="${{ needs.get-snapshot-updates.outputs.pr-head-ref }}-snapshot-update-${DATE}"
          echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          git config user.name "JupyterLab Bot"
          git config user.email "bot@jupyter.org"
          git checkout -b "$BRANCH_NAME"

      - name: Remove test assets and update script
        run: |
          set -ex
          rm -f unpack_snapshots.py
          rm -rf test-assets

      - name: Compress snapshots
        shell: bash -l {0}
        run: |
          set -ex
          sudo apt install optipng
          # Apply compression only on new and modified versioned files
          # - this does not filter out deleted files but it should not happen.
          echo "::group::Optimize PNG files"
          git ls-files --exclude-standard -om | grep -e "\.png$" | xargs optipng
          echo "::endgroup::"

      - name: Stage allowed files and check for changes
        id: check-changes
        run: |
          git add -- ':(glob)galata/**/*.png' ':(glob)galata/**/*.json'

          if git diff --cached --name-only | grep -Ev '^galata/.*\.(png|json)$' >/dev/null; then
            echo "::error::Only galata/*.png and galata/*.json files are allowed in this update"
            git diff --cached --name-only
            exit 1
          fi

          if git diff --cached --quiet; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
            git diff --cached --name-status
          fi

      - name: Commit changes
        if: steps.check-changes.outputs.has-changes == 'true'
        run: |
          git commit -m "Update snapshots"

      - name: Push branch
        if: steps.check-changes.outputs.has-changes == 'true'
        run: |
          git push origin ${{ steps.create-branch.outputs.branch-name }} --force-with-lease

  open-pr:
    name: Open a new PR with updates
    runs-on: ubuntu-24.04
    needs: [get-snapshot-updates, create-branch]
    if: needs.create-branch.result == 'success' && needs.create-branch.outputs.has-changes == 'true'
    environment: update-snapshots
    permissions:
      contents: read
      pull-requests: write
    outputs:
      pr-url: ${{ steps.open-pr.outputs.pr-url }}
    steps:
      - uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ${{ needs.get-snapshot-updates.outputs.pr-head-owner }}

      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-branch.outputs.branch-name }}
          fetch-depth: 1

      - name: Open Pull Request
        id: open-pr
        run: |
          set -ex

          PR_NUMBER=${{ github.event.issue.number || github.event.pull_request.number }}
          if [ "${{ needs.get-snapshot-updates.outputs.is-pr-from-fork }}" = "true" ]; then
            TARGET_REPO="${{ needs.get-snapshot-updates.outputs.pr-head-repo }}"
            BASE_REF="${{ needs.get-snapshot-updates.outputs.pr-head-ref }}"
            HEAD_REF="${{ github.repository_owner }}:${{ needs.create-branch.outputs.branch-name }}"
          else
            TARGET_REPO="${{ github.repository }}"
            BASE_REF="${{ needs.get-snapshot-updates.outputs.pr-head-ref }}"
            HEAD_REF="${{ needs.create-branch.outputs.branch-name }}"
          fi

          # Create PR title and body
          PR_TITLE="Update galata snapshots for PR #${PR_NUMBER}"
          PR_BODY=$(cat <<EOF
          ## Updates galata snapshots

          This PR updates the galata test snapshots based on the test results from #${PR_NUMBER}.

          **Source PR**: #${PR_NUMBER}
          **Base branch**: ${BASE_REF}
          EOF
          )

          # Open the PR
          PR_URL=$(gh pr create \
            --base "$BASE_REF" \
            --head "$HEAD_REF" \
            --title "$PR_TITLE" \
            --body "$PR_BODY" \
            --repo "$TARGET_REPO")

          echo "pr-url=$PR_URL" >> $GITHUB_OUTPUT
          echo "Opened PR: $PR_URL"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

  comment-back:
    name: Comment back on the PR
    runs-on: ubuntu-slim
    needs: [open-pr, create-branch]
    if: always()
    environment: update-snapshots
    steps:
      - uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Compose comment message
        id: compose-message
        run: |
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [ "${{ needs.create-branch.result }}" != "success" ]; then
            BODY="Snapshot update failed while preparing or pushing the update branch. [Workflow run](${RUN_URL})"
          elif [ "${{ needs.create-branch.outputs.has-changes }}" = "false" ]; then
            BODY="No snapshot changes detected. [Workflow run](${RUN_URL})"
          elif [ "${{ needs.open-pr.result }}" != "success" ]; then
            BODY="Snapshot changes were prepared, but opening the snapshot update PR failed. [Workflow run](${RUN_URL})"
          else
            BODY="Snapshot update PR created: ${{ needs.open-pr.outputs.pr-url }}"
          fi

          echo "body=$BODY" >> $GITHUB_OUTPUT

      - name: Comment back on the PR
        run: |
          PR_NUMBER=${{ github.event.issue.number || github.event.pull_request.number }}
          gh api repos/${{ github.repository }}/issues/${PR_NUMBER}/comments \
            --raw-field "body=${{ steps.compose-message.outputs.body }}"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
